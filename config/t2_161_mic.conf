# SPDX-License-Identifier: MIT
# (C) 2023 Linux T2 Kernel Team

context.modules = [
    { name = libpipewire-module-filter-chain
        args = {
            #audio.format    = F32
            #audio.rate      = 48000
            audio.channels   = 2
            audio.position   = [ AUX0 AUX1]
            node.description = "MacBook Pro T2 DSP Mic"
            media.name       = "MacBook Pro T2 DSP Mic"
            filter.graph = {
                nodes = [
                    {
                        name = mix
                        type = builtin
                        label = mixer
                        control = {"Gain 1" = 1.0 "Gain 2" = 1.0 "Gain 3" = 1.0}
                    }
                    {
                        type   = ladspa
                        name   = rnnoise
                        plugin = /usr/local/lib/ladspa/librnnoise_ladspa.so
                        #plugin = ~/Downloads/linux-rnnoise/ladspa/librnnoise_ladspa.so
                        label  = noise_suppressor_stereo
                        control = {
                            "VAD Threshold (%)" 85.0
                            #"VAD Grace Period (ms)" 100.0
                            #"Retroactive VAD Grace (ms)" 0.0
                        }
                    }
                    {
                         type   = ladspa
                         name   = compressor
                         plugin = sc4_1882
                         label  = sc4
                         control = { "RMS/peak" = 0 "Attack time (ms)" = 60 "Release time (ms)" = 600 "Threshold level (dB)" = -6 "Ratio (1:n)" = 12 "Knee radius (dB)" = 2 "Makeup gain (dB)" = 12 }
                     }
                     {
                         type   = ladspa
                         name   = limiter
                         plugin = fast_lookahead_limiter_1913
                         label  = fastLookaheadLimiter
                         control = { "Input gain (dB)" = 21 "Limit (dB)" = -6 "Release time (s)" = 0.8 }
                     }
                ]
                links = [
                    { output = "mix:Out" input = "rnnoise:Input (L)" }
                    { output = "mix:Out" input = "rnnoise:Input (R)" }
                    { output = "rnnoise:Output (L)" input = "compressor:Left input" }
                    { output = "rnnoise:Output (R)" input = "compressor:Right input" }
                    { output = "compressor:Left output" input = "limiter:Input 2" }
                    { output = "compressor:Right output" input = "limiter:Input 1" }
                ]
                inputs = [ "mix:In 1" "mix:In 2" "mix:In 3"]
                outputs = [ "limiter:Output 1" "limiter:Output 2"]
            }
            capture.props = {
                node.name        = "effect_input.filter-chain-mic"
                audio.position = [AUX0 AUX1 AUX2]
                stream.dont-remix = true
                node.target = "alsa_input.pci-0000_04_00.3.BuiltinMic"
                node.passive = true
            }
            playback.props = {
                node.name = "effect_output.filter-chain-mic"
                media.class = Audio/Source
                node.passive = true
            }
        }
    }
]
